name: Upload Conda Package

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Conda Environment
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.11"
          # Important: Install build tools and the upload client here
          activate-environment: build_env
          channels: conda-forge,defaults
          
      # Install Build Dependencies
      - name: Install Build Tools
        shell: bash -l {0}
        run: |
          conda install -y conda-build anaconda-client
          # Install your project dependencies needed for the recipe (host requirements)
          conda install -y setuptools wheel hatchling pip

      # Build the Package
      - name: Build Conda Package
        shell: bash -l {0}
        run: |
          # Build the package using the recipe in the 'conda' folder
          conda build ./conda --output-folder ./build_output

      # Upload to Anaconda
      - name: Upload to Anaconda
        shell: bash -l {0}
        env:
          ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
          # Replace with your actual Anaconda username
          ANACONDA_USER: davidusb 
        run: |
          # Find the built tar.bz2 file
          # We use a wildcard because the exact filename includes version/build strings
          # The -t flag provides the auth token
          # The -u flag specifies the user/org to upload to
          anaconda -t $ANACONDA_TOKEN upload -u $ANACONDA_USER ./build_output/noarch/*.tar.bz2 --force