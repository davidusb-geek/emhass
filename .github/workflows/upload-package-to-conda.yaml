name: Upload Conda Package

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Conda Environment
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          # Important: Install build tools and the upload client here
          activate-environment: build_env
          channels: conda-forge,defaults
          
      # Install Build Dependencies
      - name: Install Build Tools
        shell: bash -l {0}
        run: |
          conda install -y conda-build anaconda-client
          # Install your project dependencies needed for the recipe (host requirements)
          conda install -y setuptools wheel hatchling pip

      # Build the Package
      - name: Build Conda Package
        shell: bash -l {0}
        run: |
          mkdir -p build_output
          conda build ./conda --output-folder ./build_output

      # Debug: List generated files (Helps verify where the file actually went)
      - name: Debug Build Output
        run: ls -R ./build_output

      # Upload to Anaconda
      - name: Upload to Anaconda
        shell: bash -l {0}
        env:
          ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
          ANACONDA_USER: davidusb
        run: |
          # Find the .tar.bz2 file wherever it is (noarch or linux-64) and upload it
          # This avoids wildcard expansion errors
          find ./build_output -name "*.tar.bz2" -exec anaconda -t $ANACONDA_TOKEN upload -u $ANACONDA_USER {} --force \;