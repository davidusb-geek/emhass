#!/bin/bash
set -e

# Set defaults
EMHASS_SERVER_TYPE=${EMHASS_SERVER_TYPE:-async}
WORKER_CLASS=${WORKER_CLASS:-uvicorn.workers.UvicornWorker}
PORT=${PORT:-5000}
IP=${IP:-0.0.0.0}

echo "=================================================="
echo "üöÄ Starting EMHASS Energy Management System"
echo "=================================================="
echo "üìã Configuration:"
echo "   Server Type: $EMHASS_SERVER_TYPE"
echo "   Worker Class: $WORKER_CLASS"
echo "   Bind Address: $IP:$PORT"
echo "   Python Path: $(which python3 2>/dev/null || echo 'N/A')"
echo "   UV Version: $(uv --version 2>/dev/null || echo 'N/A')"
echo "=================================================="

# Validate server type
case "$EMHASS_SERVER_TYPE" in
    sync)
        echo "üì¶ Using synchronous Flask server with gunicorn"
        echo "üîß Starting gunicorn with WSGI workers..."
        exec uv run --frozen gunicorn emhass.web_server:app -c gunicorn.conf.py
        ;;
    async)
        echo "‚ö° Using asynchronous Quart server with gunicorn + uvicorn workers"
        echo "üîß Starting gunicorn with $WORKER_CLASS workers..."
        exec uv run --frozen gunicorn emhass.web_server_async:app -c gunicorn.conf.py -k "$WORKER_CLASS"
        ;;
    hypercorn)
        echo "üåê Using Hypercorn ASGI server (legacy mode)"
        echo "üîß Starting hypercorn server..."
        exec uv run --frozen hypercorn emhass.web_server_async:app --bind "$IP:$PORT" --workers 1 --access-logfile - --error-logfile -
        ;;
    *)
        echo "‚ùå ERROR: Unknown server type '$EMHASS_SERVER_TYPE'"
        echo "üìñ Valid options:"
        echo "   - sync: Flask with gunicorn WSGI workers"
        echo "   - async: Quart with gunicorn + uvicorn ASGI workers (recommended)"
        echo "   - hypercorn: Quart with hypercorn ASGI server (legacy)"
        echo ""
        echo "üí° Example: docker run -e EMHASS_SERVER_TYPE=async your-image"
        exit 1
        ;;
esac
